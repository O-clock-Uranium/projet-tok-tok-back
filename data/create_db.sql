BEGIN;
DROP TABLE IF EXISTS "user",
"like",
"post",
"message",
"favourite",
"advert",
"advert_has_image",
"tag",
"conversation";

CREATE TABLE "user" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  firstname VARCHAR(64) NOT NULL,
  lastname VARCHAR(64) NOT NULL,
  description VARCHAR(255),
  address TEXT NOT NULL,
  city TEXT NOT NULL,
  longitude TEXT NOT NULL,
  latitude TEXT NOT NULL,
  email VARCHAR(64) NOT NULL,
  password VARCHAR(64) NOT NULL,
  thumbnail TEXT,
  banner TEXT DEFAULT 'http://localhost:3000/images/default-banner-picture.png',
  slug TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE "tag" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  name VARCHAR(64) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE "advert" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  title VARCHAR(64) NOT NULL,
  content TEXT NOT NULL,
  price SMALLINT NOT NULL,
  user_id INTEGER NOT NULL,
  tag_id INTEGER NOT NULL,
  slug TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES "user"(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES "tag"(id)
);
CREATE TABLE "advert_has_image" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  advert_id INTEGER NOT NULL,
  thumbnail TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (advert_id) REFERENCES "advert"("id") ON DELETE CASCADE
);
CREATE TABLE "post" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  content TEXT NOT NULL,
  thumbnail TEXT,
  reply_to INTEGER REFERENCES "post"("id") ON DELETE CASCADE,
  user_id INTEGER NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES "user"(id) ON DELETE CASCADE
);

CREATE TABLE "conversation" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  user1 INTEGER NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  user2 INTEGER NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE "message" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  content TEXT NOT NULL,
  sender INTEGER NOT NULL,
  conversation_id INTEGER NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (sender) REFERENCES "user"(id) ON DELETE CASCADE,
  FOREIGN KEY (conversation_id) REFERENCES "conversation"(id) ON DELETE CASCADE
);
CREATE TABLE "favourite" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  advert_id INTEGER NOT NULL,
  user_id INTEGER NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (advert_id) REFERENCES "advert"(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES "user"(id) ON DELETE CASCADE
);
CREATE TABLE "like" (
  id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  post_id INTEGER NOT NULL,
  user_id INTEGER NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES "post"(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES "user"(id) ON DELETE CASCADE
);
  
  COMMIT ; 